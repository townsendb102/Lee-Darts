<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DartStream Fix</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>
    <style>
        body { margin: 0; background: #020408; color: white; font-family: sans-serif; overflow: hidden; }
        
        /* The Overlay */
        #setup-screen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #020408; z-index: 10000; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        /* The Button - Made extra large for easy tapping */
        #start-btn { 
            background: #00d4ff; color: #000; 
            border: none; padding: 25px 60px; 
            font-size: 24px; font-weight: bold; border-radius: 50px;
            cursor: pointer; -webkit-appearance: none;
            touch-action: manipulation;
        }

        #start-btn:active { background: #ffcc00; transform: scale(0.95); }

        #status-msg { margin-top: 20px; color: #888; font-size: 14px; text-align: center; padding: 0 20px; }

        /* App Layout */
        header { height: 50px; border-bottom: 1px solid #1b4965; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; }
        .v-grid { display: grid; grid-template-columns: 1fr 1fr; height: 30vh; background: #000; }
        video { width: 100%; height: 100%; object-fit: cover; background: #111; }
        .scores { flex: 1; display: flex; flex-direction: column; padding: 10px; gap: 10px; height: 40vh; }
        .card { flex: 1; background: #0d1b2a; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 60px; border: 2px solid transparent; }
        .card.active { border-color: #00d4ff; background: #122c44; }
        .controls { height: 80px; display: flex; padding: 10px; gap: 10px; background: #000; }
        input { flex: 1; font-size: 30px; text-align: center; border-radius: 10px; border: none; }
        button.hit { width: 100px; background: #00d4ff; border: none; border-radius: 10px; font-weight: bold; }
    </style>
</head>
<body>

<div id="setup-screen">
    <h1 style="color:#00d4ff">DARTSTREAM</h1>
    <button id="start-btn">START APP</button>
    <div id="status-msg">Tap the button to enable Camera</div>
</div>

<header>
    <div>ID: <span id="my-id">...</span></div>
    <button onclick="shareLink()" style="background:#1b4965; color:white; border:none; padding:5px 10px; border-radius:5px;">INVITE</button>
</header>

<div class="v-grid">
    <video id="me" autoplay playsinline muted></video>
    <video id="peer" autoplay playsinline></video>
</div>

<div class="scores">
    <div id="c0" class="card active">501</div>
    <div id="c1" class="card">501</div>
</div>

<div class="controls">
    <input type="number" id="pts" placeholder="0" inputmode="numeric">
    <button class="hit" onclick="doHit()">HIT</button>
</div>

<script>
    const msg = (t) => { document.getElementById('status-msg').innerText = t; };
    let localStream, peer, conn;
    let state = { turn: 0, s: [501, 501] };

    // Wait for full window load
    window.onload = () => {
        msg("Ready. Tap START.");
        
        document.getElementById('start-btn').addEventListener('click', async function() {
            msg("Initializing... please wait.");
            this.style.display = 'none'; // Hide button to prevent double-click

            try {
                // 1. Camera
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "user" }, 
                    audio: true 
                });
                document.getElementById('me').srcObject = localStream;
                msg("Camera active. Connecting to network...");

                // 2. PeerJS
                peer = new Peer();

                peer.on('open', (id) => {
                    document.getElementById('my-id').innerText = id;
                    document.getElementById('setup-screen').style.display = 'none';
                    checkInvite();
                });

                peer.on('call', (call) => {
                    call.answer(localStream);
                    call.on('stream', s => document.getElementById('peer').srcObject = s);
                });

                peer.on('connection', c => {
                    conn = c;
                    conn.on('data', d => { state = d; updateUI(); });
                });

                peer.on('error', e => {
                    alert("Network Error: " + e.type);
                    location.reload(); 
                });

            } catch (err) {
                msg("Error: " + err.message);
                this.style.display = 'block';
                this.innerText = "TRY AGAIN";
                alert("Please use HTTPS and allow camera access.");
            }
        });
    };

    function doHit() {
        let p = document.getElementById('pts');
        let v = parseInt(p.value) || 0;
        state.s[state.turn] -= v;
        state.turn = state.turn === 0 ? 1 : 0;
        updateUI();
        if(conn) conn.send(state);
        p.value = '';
    }

    function updateUI() {
        document.getElementById('c0').innerText = state.s[0];
        document.getElementById('c1').innerText = state.s[1];
        document.getElementById('c0').className = state.turn === 0 ? 'card active' : 'card';
        document.getElementById('c1').className = state.turn === 1 ? 'card active' : 'card';
    }

    function shareLink() {
        const id = document.getElementById('my-id').innerText;
        const url = window.location.origin + window.location.pathname + '?join=' + id;
        navigator.clipboard.writeText(url);
        alert("Invite link copied to clipboard!");
    }

    function checkInvite() {
        const urlParams = new URLSearchParams(window.location.search);
        const joinId = urlParams.get('join');
        if (joinId) {
            conn = peer.connect(joinId);
            const call = peer.call(joinId, localStream);
            call.on('stream', s => document.getElementById('peer').srcObject = s);
        }
    }
</script>
</body>
</html>
