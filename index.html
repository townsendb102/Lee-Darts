    const sounds = { '180': new Audio('https://www.soundboard.com/handler/DownLoadTrack.ashx?cliptoken=649735'), 'win': new Audio('https://www.soundboard.com/handler/DownLoadTrack.ashx?cliptoken=649734') };
    
    let peer, conn, localStream, currentFacingMode = "user", friends = JSON.parse(localStorage.getItem('dartFriends') || '[]');
    let state = { turn: 0, p: [{s:501, l:0, pts:0, d:0}, {s:501, l:0, pts:0, d:0}] };
    let history = null;

    // Fixed initialization function
    async function initApp() {
        const startBtn = document.querySelector('#setup-screen button');
        startBtn.innerText = "STARTING...";
        startBtn.disabled = true;

        try {
            // 1. Get Camera Access
            localStream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: currentFacingMode }, 
                audio: true 
            });
            document.getElementById('me').srcObject = localStream;
            
            // 2. Setup Peer
            peer = new Peer();
            
            peer.on('open', id => { 
                document.getElementById('my-id').innerText = id; 
                renderFriends();
                // 3. Only hide screen once ID is ready
                document.getElementById('setup-screen').style.display = 'none';
            });

            peer.on('connection', c => { 
                conn = c; 
                setupData(); 
                document.getElementById('conn-status').innerText = "● CONNECTED";
                document.getElementById('conn-status').style.color = "var(--blue)";
            });

            peer.on('call', call => { 
                call.answer(localStream); 
                call.on('stream', s => document.getElementById('peer').srcObject = s); 
            });

            // 4. Keep screen awake
            if ('wakeLock' in navigator) {
                try { await navigator.wakeLock.request('screen'); } catch(e) {}
            }

        } catch (e) { 
            console.error(e);
            alert("Camera Error: Please ensure you are on HTTPS and granted permissions."); 
            startBtn.innerText = "RETRY START";
            startBtn.disabled = false;
        }
    }

    function toggleMenu() {
        const menu = document.getElementById('menu-panel');
        const overlay = document.getElementById('overlay');
        menu.classList.toggle('open');
        overlay.style.display = menu.classList.contains('open') ? 'block' : 'none';
    }

    // Fixed Camera Flip to handle track replacement
    async function flipCamera() {
        currentFacingMode = currentFacingMode === "user" ? "environment" : "user";
        
        if (localStream) {
            localStream.getTracks().forEach(t => t.stop());
        }

        try {
            localStream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: currentFacingMode }, 
                audio: true 
            });
            document.getElementById('me').srcObject = localStream;
            
            // If we have an active connection, we'd normally need to re-call or replace tracks
            // For now, this refreshes your local view.
            toggleMenu();
        } catch (e) {
            alert("Could not switch camera.");
        }
    }

    function addFriend() {
        const nameInput = document.getElementById('new-friend-name');
        const idInput = document.getElementById('new-friend-id');
        if(nameInput.value && idInput.value) {
            friends.push({name: nameInput.value, id: idInput.value});
            localStorage.setItem('dartFriends', JSON.stringify(friends));
            nameInput.value = '';
            idInput.value = '';
            renderFriends();
        }
    }

    function deleteFriend(index) {
        friends.splice(index, 1);
        localStorage.setItem('dartFriends', JSON.stringify(friends));
        renderFriends();
    }

    function renderFriends() {
        const container = document.getElementById('friends-list');
        container.innerHTML = friends.map((f, i) => `
            <div class="friend-item">
                <div onclick="join('${f.id}', '${f.name}')" style="flex:1; cursor:pointer">
                    <span class="friend-name">${f.name}</span>
                    <span class="friend-id">${f.id}</span>
                </div>
                <button onclick="deleteFriend(${i})" style="background:none; border:none; color:#ff4444; font-size:18px">×</button>
            </div>
        `).join('');
    }

    function join(id, name) {
        document.getElementById('p2-label').innerText = name.toUpperCase();
        conn = peer.connect(id);
        setupData();
        const call = peer.call(id, localStream);
        call.on('stream', s => document.getElementById('peer').srcObject = s);
        toggleMenu();
        document.getElementById('conn-status').innerText = "● CONNECTED";
        document.getElementById('conn-status').style.color = "var(--blue)";
    }

    function setupData() {
        conn.on('data', d => { 
            state = d; 
            render(); 
            if(d.snd && sounds[d.snd]) sounds[d.snd].play(); 
        });
        conn.on('close', () => {
            document.getElementById('conn-status').innerText = "● DISCONNECTED";
            document.getElementById('conn-status').style.color = "#555";
        });
    }

    function copyMyID() {
        const id = document.getElementById('my-id').innerText;
        navigator.clipboard.writeText(id);
        document.getElementById('hint').innerText = "ID COPIED: " + id;
        setTimeout(() => document.getElementById('hint').innerText = "", 2000);
    }

    function hit() {
        let el = document.getElementById('pts');
        let v = parseInt(el.value) || 0;
        if (v > 180) return;
        history = JSON.parse(JSON.stringify(state));
        let p = state.p[state.turn];
        let snd = (v === 180) ? '180' : null;
        if (p.s - v >= 0 && p.s - v !== 1) {
            p.s -= v; p.pts += v; p.d += 3;
            if (p.s === 0) { p.l++; state.p.forEach(x => x.s = 501); snd = 'win'; }
            else { state.turn = state.turn === 0 ? 1 : 0; }
        } else { state.turn = state.turn === 0 ? 1 : 0; }
        state.snd = snd;
        if(snd) sounds[snd].play();
        render();
        if(conn) conn.send(state);
        el.value = '';
    }

    function undo() {
        if (history) { state = JSON.parse(JSON.stringify(history)); history = null; render(); if(conn) conn.send(state); }
    }

    function render() {
        state.p.forEach((p, i) => {
            document.getElementById(`s${i}`).innerText = p.s;
            document.getElementById(`l${i}`).innerText = p.l;
            document.getElementById(`a${i}`).innerText = p.d > 0 ? ((p.pts / p.d) * 3).toFixed(1) : "0";
            document.getElementById(`c${i}`).className = i === state.turn ? 'p-card active' : 'p-card';
        });
    }
